var THREEx=THREEx||{};THREEx.DomEvents=function(t,e){this._camera=t||null,this._domElement=e||document,this._raycaster=new THREE.Raycaster,this._selected=null,this._boundObjs={};var o=this;this._$onClick=function(){o._onClick.apply(o,arguments)},this._$onDblClick=function(){o._onDblClick.apply(o,arguments)},this._$onMouseMove=function(){o._onMouseMove.apply(o,arguments)},this._$onMouseDown=function(){o._onMouseDown.apply(o,arguments)},this._$onMouseUp=function(){o._onMouseUp.apply(o,arguments)},this._$onTouchMove=function(){o._onTouchMove.apply(o,arguments)},this._$onTouchStart=function(){o._onTouchStart.apply(o,arguments)},this._$onTouchEnd=function(){o._onTouchEnd.apply(o,arguments)},this._$onContextmenu=function(){o._onContextmenu.apply(o,arguments)},this._domElement.addEventListener("click",this._$onClick,!1),this._domElement.addEventListener("dblclick",this._$onDblClick,!1),this._domElement.addEventListener("mousemove",this._$onMouseMove,!1),this._domElement.addEventListener("mousedown",this._$onMouseDown,!1),this._domElement.addEventListener("mouseup",this._$onMouseUp,!1),this._domElement.addEventListener("touchmove",this._$onTouchMove,!1),this._domElement.addEventListener("touchstart",this._$onTouchStart,!1),this._domElement.addEventListener("touchend",this._$onTouchEnd,!1),this._domElement.addEventListener("contextmenu",this._$onContextmenu,!1)},THREEx.DomEvents.prototype.destroy=function(){this._domElement.removeEventListener("click",this._$onClick,!1),this._domElement.removeEventListener("dblclick",this._$onDblClick,!1),this._domElement.removeEventListener("mousemove",this._$onMouseMove,!1),this._domElement.removeEventListener("mousedown",this._$onMouseDown,!1),this._domElement.removeEventListener("mouseup",this._$onMouseUp,!1),this._domElement.removeEventListener("touchmove",this._$onTouchMove,!1),this._domElement.removeEventListener("touchstart",this._$onTouchStart,!1),this._domElement.removeEventListener("touchend",this._$onTouchEnd,!1),this._domElement.removeEventListener("contextmenu",this._$onContextmenu,!1)},THREEx.DomEvents.eventNames=["click","dblclick","mouseover","mouseout","mousemove","mousedown","mouseup","contextmenu","touchstart","touchend"],THREEx.DomEvents.prototype._getRelativeMouseXY=function(t){var e=t.target||t.srcElement;3===e.nodeType&&(e=e.parentNode);var o={x:0,y:0},n=e,s=getComputedStyle(n,null);o.y+=parseInt(s.getPropertyValue("padding-top"),10),o.x+=parseInt(s.getPropertyValue("padding-left"),10);do o.x+=n.offsetLeft,o.y+=n.offsetTop,s=getComputedStyle(n,null),o.x+=parseInt(s.getPropertyValue("border-left-width"),10),o.y+=parseInt(s.getPropertyValue("border-top-width"),10);while(n=n.offsetParent);var i={width:e===window?window.innerWidth:e.offsetWidth,height:e===window?window.innerHeight:e.offsetHeight};return{x:2*+((t.pageX-o.x)/i.width)-1,y:2*-((t.pageY-o.y)/i.height)+1}},THREEx.DomEvents.prototype._objectCtxInit=function(t){t._3xDomEvent={}},THREEx.DomEvents.prototype._objectCtxDeinit=function(t){delete t._3xDomEvent},THREEx.DomEvents.prototype._objectCtxIsInit=function(t){return!!t._3xDomEvent},THREEx.DomEvents.prototype._objectCtxGet=function(t){return t._3xDomEvent},THREEx.DomEvents.prototype.camera=function(t){return t&&(this._camera=t),this._camera},THREEx.DomEvents.prototype.bind=function(t,e,o,n){console.assert(THREEx.DomEvents.eventNames.indexOf(e)!==-1,"not available events:"+e),this._objectCtxIsInit(t)||this._objectCtxInit(t);var s=this._objectCtxGet(t);s[e+"Handlers"]||(s[e+"Handlers"]=[]),s[e+"Handlers"].push({callback:o,useCapture:n}),void 0===this._boundObjs[e]&&(this._boundObjs[e]=[]),this._boundObjs[e].push(t)},THREEx.DomEvents.prototype.addEventListener=THREEx.DomEvents.prototype.bind,THREEx.DomEvents.prototype.unbind=function(t,e,o,n){console.assert(THREEx.DomEvents.eventNames.indexOf(e)!==-1,"not available events:"+e),this._objectCtxIsInit(t)||this._objectCtxInit(t);var s=this._objectCtxGet(t);s[e+"Handlers"]||(s[e+"Handlers"]=[]);for(var i=s[e+"Handlers"],r=0;r<i.length;r++){var u=i[r];if(o==u.callback&&n==u.useCapture){i.splice(r,1);break}}var h=this._boundObjs[e].indexOf(t);console.assert(h!==-1),this._boundObjs[e].splice(h,1)},THREEx.DomEvents.prototype.removeEventListener=THREEx.DomEvents.prototype.unbind,THREEx.DomEvents.prototype._bound=function(t,e){var o=this._objectCtxGet(e);return!!o&&!!o[t+"Handlers"]},THREEx.DomEvents.prototype._onMove=function(t,e,o,n){var s=this._boundObjs[t];if(void 0!==s&&0!==s.length){var i=new THREE.Vector2;i.set(e,o),this._raycaster.setFromCamera(i,this._camera);var r=this._raycaster.intersectObjects(s),u=this._selected;if(r.length>0){var h,E,c,v=r[0],a=v.object;this._selected=a,c=this._bound("mousemove",a),u!=a&&(h=this._bound("mouseover",a),E=u&&this._bound("mouseout",u))}else E=u&&this._bound("mouseout",u),this._selected=null;c&&this._notify("mousemove",a,n,v),h&&this._notify("mouseover",a,n,v),E&&this._notify("mouseout",u,n,v)}},THREEx.DomEvents.prototype._onEvent=function(t,e,o,n){var s=this._boundObjs[t];if(void 0!==s&&0!==s.length){var i=new THREE.Vector2;i.set(e,o),this._raycaster.setFromCamera(i,this._camera);var r=this._raycaster.intersectObjects(s,!0);if(0!==r.length){for(var u=r[0],h=u.object,E=this._objectCtxGet(h),c=h.parent;"undefined"==typeof E&&c;)E=this._objectCtxGet(c),c=c.parent;E&&this._notify(t,h,n,u)}}},THREEx.DomEvents.prototype._notify=function(t,e,o,n){var s=this._objectCtxGet(e),i=s?s[t+"Handlers"]:null;if(console.assert(4===arguments.length),!s||!i||0===i.length)return void(e.parent&&this._notify(t,e.parent,o,n));for(var i=s[t+"Handlers"],r=0;r<i.length;r++){var u=i[r],h=!0;u.callback({type:t,target:e,origDomEvent:o,intersect:n,stopPropagation:function(){h=!1}}),h&&u.useCapture===!1&&e.parent&&this._notify(t,e.parent,o,n)}},THREEx.DomEvents.prototype._onMouseDown=function(t){return this._onMouseEvent("mousedown",t)},THREEx.DomEvents.prototype._onMouseUp=function(t){return this._onMouseEvent("mouseup",t)},THREEx.DomEvents.prototype._onMouseEvent=function(t,e){var o=this._getRelativeMouseXY(e);this._onEvent(t,o.x,o.y,e)},THREEx.DomEvents.prototype._onMouseMove=function(t){var e=this._getRelativeMouseXY(t);this._onMove("mousemove",e.x,e.y,t),this._onMove("mouseover",e.x,e.y,t),this._onMove("mouseout",e.x,e.y,t)},THREEx.DomEvents.prototype._onClick=function(t){this._onMouseEvent("click",t)},THREEx.DomEvents.prototype._onDblClick=function(t){this._onMouseEvent("dblclick",t)},THREEx.DomEvents.prototype._onContextmenu=function(t){this._onMouseEvent("contextmenu",t)},THREEx.DomEvents.prototype._onTouchStart=function(t){return this._onTouchEvent("touchstart",t)},THREEx.DomEvents.prototype._onTouchEnd=function(t){return this._onTouchEvent("touchend",t)},THREEx.DomEvents.prototype._onTouchMove=function(t){if(1==t.touches.length){t.preventDefault();var e=2*+(t.touches[0].pageX/window.innerWidth)-1,o=2*-(t.touches[0].pageY/window.innerHeight)+1;this._onMove("mousemove",e,o,t),this._onMove("mouseover",e,o,t),this._onMove("mouseout",e,o,t)}},THREEx.DomEvents.prototype._onTouchEvent=function(t,e){if(1==e.touches.length){e.preventDefault();var o=2*+(e.touches[0].pageX/window.innerWidth)-1,n=2*-(e.touches[0].pageY/window.innerHeight)+1;this._onEvent(t,o,n,e)}};